#!/usr/bin/env bash
#
# AI Docs System â€” Pre-commit Hook (ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹)
# ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°ĞµÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ ĞºĞ¾Ğ´Ğ°
# ĞĞ• Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ñ‹ â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ´Ñ€ÑƒĞ¶ĞµÑĞºĞ¾Ğµ Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ
#
# âš ï¸  ĞšĞĞŸĞ˜Ğ¯! Ğ˜ÑÑ‚Ğ¸Ğ½Ğ° Ğ²: githooks/pre-commit
# âš ï¸  ĞĞµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ install.sh update
#
# ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ: .ai-docs-system/config.env
#

# ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² ĞºĞ¾Ñ€ĞµĞ½ÑŒ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
cd "$repo_root" || exit 0

# â”€â”€â”€ Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğ¹ Ğ¸Ğ· config.env (Ğ±ĞµĞ· Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ´Ğ°)
get_config_value() {
  local file="$1" key="$2" default="$3"
  grep -E "^${key}=" "$file" 2>/dev/null | cut -d'=' -f2- | head -1 || echo "$default"
}

# â”€â”€â”€ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
config=".ai-docs-system/config.env"

# Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
CODE_DIRS="src,app,apps,packages,services,server,client,api,lib,cmd,internal,supabase"
CODE_EXTS="ts,tsx,js,jsx,mjs,cjs,py,go,rs,java,kt,kts,cs,php,rb,swift,c,cpp,h,hpp,sql,graphql,proto"
DOC_DIRS="docs,doc,documentation"
DOC_EXTS="md,mdx,rst,adoc"
DOC_FILES="README.md,CHANGELOG.md,CONTRIBUTING.md,ARCHITECTURE.md"
IGNORE_DIRS="node_modules,vendor,dist,build,.git,.idea,.vscode,__pycache__,.next,.nuxt"

# Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸Ğ· ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ° (ĞµÑĞ»Ğ¸ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚)
if [[ -f "$config" ]]; then
  CODE_DIRS="$(get_config_value "$config" "CODE_DIRS" "$CODE_DIRS")"
  CODE_EXTS="$(get_config_value "$config" "CODE_EXTS" "$CODE_EXTS")"
  DOC_DIRS="$(get_config_value "$config" "DOC_DIRS" "$DOC_DIRS")"
  DOC_EXTS="$(get_config_value "$config" "DOC_EXTS" "$DOC_EXTS")"
  DOC_FILES="$(get_config_value "$config" "DOC_FILES" "$DOC_FILES")"
  IGNORE_DIRS="$(get_config_value "$config" "IGNORE_DIRS" "$IGNORE_DIRS")"
fi

# â”€â”€â”€ Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Ğ­ĞºÑ€Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¿ĞµÑ†ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² regex
escape_regex() {
  sed 's/[.[\*^$()+?{|\\]/\\&/g'
}

# CSV Ğ² regex Ñ ÑĞºÑ€Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼: "a,b,c" â†’ "(a|b|c)"
csv_to_re() {
  local s="${1:-}" IFS=,
  local out=() token
  for token in $s; do
    token="$(printf '%s' "$token" | escape_regex)"
    out+=("$token")
  done
  printf '(%s)' "$(IFS='|'; echo "${out[*]}")"
}

# â”€â”€â”€ ĞŸĞ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ regex Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CODE_DIRS_RE="$(csv_to_re "$CODE_DIRS")"
CODE_EXTS_RE="$(csv_to_re "$CODE_EXTS")"
DOC_DIRS_RE="$(csv_to_re "$DOC_DIRS")"
DOC_EXTS_RE="$(csv_to_re "$DOC_EXTS")"
DOC_FILES_RE="$(csv_to_re "$DOC_FILES")"
IGNORE_DIRS_RE="$(csv_to_re "$IGNORE_DIRS")"

# ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½ Ğ´Ğ»Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸: Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¿Ğ°Ğ¿ĞºĞ¸ docs/ Ğ˜Ğ›Ğ˜ ĞºĞ¾Ñ€Ğ½ĞµĞ²Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ (README.md Ğ¸ Ñ‚.Ğ´.)
# ĞĞ• Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ *.md Ğ²ĞµĞ·Ğ´Ğµ â€” Ğ¸Ğ½Ğ°Ñ‡Ğµ .ai-docs-system/instructions.md ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸ĞµĞ¹
DOCS_RE="^${DOC_DIRS_RE}/|^${DOC_FILES_RE}$"

# ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½ Ğ´Ğ»Ñ ĞºĞ¾Ğ´Ğ°: Ğ¿Ğ°Ğ¿ĞºĞ¸ src/ Ğ¸ Ñ‚.Ğ´. Ğ˜Ğ›Ğ˜ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¼Ğ¸ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸ÑĞ¼Ğ¸
CODE_RE="^${CODE_DIRS_RE}/|\\.${CODE_EXTS_RE}$|(^|/)(Dockerfile|Makefile|docker-compose\\.ya?ml)$"

# ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½ Ğ´Ğ»Ñ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ñ…: apps/web/node_modules/)
IGNORE_RE="(^|/)${IGNORE_DIRS_RE}/|\\.ai-docs-system/"

# â”€â”€â”€ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ (Ñ NUL-Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»ĞµĞ¼ Ğ´Ğ»Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
changed_docs=""
changed_code=""
changed_code_all=()   # Ğ’Ğ¡Ğ• Ñ„Ğ°Ğ¹Ğ»Ñ‹ ĞºĞ¾Ğ´Ğ° (Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ)
changed_code_arr=()   # ĞŸĞµÑ€Ğ²Ñ‹Ğµ 10 Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² (Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°)

# Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ‡ĞµÑ€ĞµĞ· NUL-Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»ÑŒ
while IFS= read -r -d '' file; do
  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ
  if echo "$file" | grep -Eq "$DOCS_RE"; then
    changed_docs="yes"
  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ° ĞºĞ¾Ğ´ (Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾Ğµ)
  elif echo "$file" | grep -Evq "$IGNORE_RE" && echo "$file" | grep -Eq "$CODE_RE"; then
    changed_code="yes"
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ’Ğ¡Ğ• Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² (Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ)
    changed_code_all+=("$file")
    # Ğ”Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 10
    if [[ ${#changed_code_arr[@]} -lt 10 ]]; then
      changed_code_arr+=("$file")
    fi
    # ĞĞ• Ğ¿Ñ€ĞµÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ†Ğ¸ĞºĞ» â€” Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ¸ÑĞºĞ°Ñ‚ÑŒ changed_docs
  fi
done < <(git diff --cached --name-only -z --diff-filter=ACMR 2>/dev/null)

# Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
[[ -z "$changed_code" && -z "$changed_docs" ]] && exit 0

# â”€â”€â”€ ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -n "$changed_code" && -z "$changed_docs" ]]; then
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âš ï¸  ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ: Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ ĞºĞ¾Ğ´, Ğ½Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ½Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Ğ˜Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹:"
  for f in "${changed_code_arr[@]}"; do
    echo "  â€¢ $f"
  done
  echo ""
  echo "ğŸ’¡ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ:"
  echo "   â€¢ Cursor Agent: Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ '==' Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ"
  echo "   â€¢ Ğ˜Ğ»Ğ¸ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ docs/"
  echo ""
  
  # â”€â”€â”€ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² pending updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if [[ -f "$config" ]]; then
    pending_local="$(get_config_value "$config" "PENDING_UPDATES_LOCAL" ".ai-docs-system/state/pending-updates.queue")"
    pending_write="$(get_config_value "$config" "PENDING_UPDATES_WRITE" "local")"
    pending_shared="$(get_config_value "$config" "PENDING_UPDATES_SHARED" "")"
    
    # ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ°
    if [[ "$pending_write" == "off" || "$pending_write" == "none" ]]; then
      : # Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ´ĞµĞ»Ğ°ĞµĞ¼
    elif [[ "$pending_write" == "local" || "$pending_write" == "shared" || "$pending_write" == "both" ]]; then
      
      # â”€â”€â”€ Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ¾Ğ±Ñ‰Ğ¸Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ (Ğ”Ğ Ğ²ĞµÑ‚Ğ²Ğ»ĞµĞ½Ğ¸Ñ local/shared) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      ts=$(date +%s)
      kind="code"
      ref="commit"
      note="pre-commit"
      
      # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞšĞĞ–Ğ”Ğ«Ğ™ Ğ¿ÑƒÑ‚ÑŒ Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ñ‹Ğµ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ²)
      has_bad_chars=false
      for f in "${changed_code_all[@]}"; do
        if [[ "$f" == *$'|'* || "$f" == *$'\t'* || "$f" == *$'\n'* ]]; then
          has_bad_chars=true
          break
        fi
      done
      
      # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ‡ĞµÑ€ĞµĞ· TAB (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ²)
      files_tab=""
      if [[ "$has_bad_chars" == false ]]; then
        files_tab=$(printf '%s\t' "${changed_code_all[@]}" | sed 's/\t$//')
      fi
      
      # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ doc_hint Ğ¿Ğ¾ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ñƒ
      doc_hint=""
      map_features="$(get_config_value "$config" "MAP_FEATURES" "src/,app/,lib/")"
      map_architecture="$(get_config_value "$config" "MAP_ARCHITECTURE" "schema,models,types")"
      map_infrastructure="$(get_config_value "$config" "MAP_INFRASTRUCTURE" "deploy,docker")"
      
      # ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ ÑĞ²Ñ€Ğ¸ÑÑ‚Ğ¸ĞºĞ°: Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ
      first_file="${changed_code_all[0]}"
      
      # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡ĞµÑ€ĞµĞ· Ñ†Ğ¸ĞºĞ» Ñ grep -F (Ğ±ĞµĞ· regex, Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´ÑÑ‚Ñ€Ğ¾Ğº)
      # Ğ’ĞĞ–ĞĞ: Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹
      IFS=',' read -ra features_arr <<< "$map_features"
      for pattern in "${features_arr[@]}"; do
        pattern=$(echo "$pattern" | xargs)
        [[ -z "$pattern" ]] && continue
        if echo "$first_file" | grep -qF "$pattern"; then
          doc_hint="docs/features/"
          break
        fi
      done
      
      if [[ -z "$doc_hint" ]]; then
        IFS=',' read -ra arch_arr <<< "$map_architecture"
        for pattern in "${arch_arr[@]}"; do
          pattern=$(echo "$pattern" | xargs)
          [[ -z "$pattern" ]] && continue
          if echo "$first_file" | grep -qF "$pattern"; then
            doc_hint="docs/architecture/"
            break
          fi
        done
      fi
      
      if [[ -z "$doc_hint" ]]; then
        IFS=',' read -ra infra_arr <<< "$map_infrastructure"
        for pattern in "${infra_arr[@]}"; do
          pattern=$(echo "$pattern" | xargs)
          [[ -z "$pattern" ]] && continue
          if echo "$first_file" | grep -qF "$pattern"; then
            doc_hint="docs/infrastructure/"
            break
          fi
        done
      fi
      
      [[ -z "$doc_hint" ]] && doc_hint="docs/"
      
      # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ entry Ğ´Ğ»Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
      entry="${ts}|${kind}|${ref}|${files_tab}|${doc_hint}|${note}"
      
      # â”€â”€â”€ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² LOCAL Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if [[ "$pending_write" == "local" || "$pending_write" == "both" ]]; then
        mkdir -p "$(dirname "$pending_local")" 2>/dev/null
        
        if [[ "$has_bad_chars" == true ]]; then
          queue0_file="${pending_local%.queue}.queue0"
          {
            printf '%s\0%s\0%s\0' "$ts" "$kind" "$ref"
            for f in "${changed_code_all[@]}"; do
              printf '%s\0' "$f"
            done
            printf '\0%s\0%s\0\0' "$doc_hint" "$note"
          } >> "$queue0_file" 2>/dev/null
        else
          echo "$entry" >> "$pending_local" 2>/dev/null
        fi
        
        echo "ğŸ“ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² pending updates (local) Ğ´Ğ»Ñ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ \"==\""
      fi
      
      # â”€â”€â”€ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² SHARED Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if [[ "$pending_write" == "shared" || "$pending_write" == "both" ]]; then
        if [[ -n "$pending_shared" ]]; then
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ°Ğ±ÑĞ¾Ğ»ÑÑ‚Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ
          shared_path=""
          if [[ "$pending_shared" == /* ]]; then
            shared_path="$pending_shared"
          else
            shared_path="$repo_root/$pending_shared"
          fi
          
          mkdir -p "$(dirname "$shared_path")" 2>/dev/null
          
          if [[ "$has_bad_chars" == true ]]; then
            shared_queue0="${shared_path%.queue}.queue0"
            {
              printf '%s\0%s\0%s\0' "$ts" "$kind" "$ref"
              for f in "${changed_code_all[@]}"; do
                printf '%s\0' "$f"
              done
              printf '\0%s\0%s\0\0' "$doc_hint" "$note"
            } >> "$shared_queue0" 2>/dev/null
          else
            echo "$entry" >> "$shared_path" 2>/dev/null
          fi
          
          echo "ğŸ“ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² pending updates (shared) â†’ $pending_shared"
        else
          echo "âš  PENDING_UPDATES_WRITE=$pending_write, Ğ½Ğ¾ PENDING_UPDATES_SHARED Ğ¿ÑƒÑÑ‚" >&2
        fi
      fi
    fi
  fi
  
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
fi

# ĞĞ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚
exit 0
