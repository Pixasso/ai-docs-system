#!/usr/bin/env bash
#
# AI Docs System — Pre-commit Hook (универсальный)
# Напоминает обновить документацию при изменении кода
# НЕ блокирует коммиты — просто дружеское напоминание
#
# Конфигурация: .ai-docs-system/config.env
#

# Переходим в корень репозитория
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
cd "$repo_root" || exit 0

# ─── Безопасное чтение конфигурации ─────────────────────────────────────────────

# Безопасная функция для чтения значений из config.env (без исполнения кода)
get_config_value() {
  local file="$1" key="$2" default="$3"
  grep -E "^${key}=" "$file" 2>/dev/null | cut -d'=' -f2- | head -1 || echo "$default"
}

# ─── Загрузка конфигурации ──────────────────────────────────────────────────────
config=".ai-docs-system/config.env"

# Значения по умолчанию
CODE_DIRS="src,app,apps,packages,services,server,client,api,lib,cmd,internal,supabase"
CODE_EXTS="ts,tsx,js,jsx,mjs,cjs,py,go,rs,java,kt,kts,cs,php,rb,swift,c,cpp,h,hpp,sql,graphql,proto"
DOC_DIRS="docs,doc,documentation"
DOC_EXTS="md,mdx,rst,adoc"
DOC_FILES="README.md,CHANGELOG.md,CONTRIBUTING.md,ARCHITECTURE.md"
IGNORE_DIRS="node_modules,vendor,dist,build,.git,.idea,.vscode,__pycache__,.next,.nuxt"

# Загрузка из конфига (если существует)
if [[ -f "$config" ]]; then
  CODE_DIRS="$(get_config_value "$config" "CODE_DIRS" "$CODE_DIRS")"
  CODE_EXTS="$(get_config_value "$config" "CODE_EXTS" "$CODE_EXTS")"
  DOC_DIRS="$(get_config_value "$config" "DOC_DIRS" "$DOC_DIRS")"
  DOC_EXTS="$(get_config_value "$config" "DOC_EXTS" "$DOC_EXTS")"
  DOC_FILES="$(get_config_value "$config" "DOC_FILES" "$DOC_FILES")"
  IGNORE_DIRS="$(get_config_value "$config" "IGNORE_DIRS" "$IGNORE_DIRS")"
fi

# ─── Вспомогательные функции ────────────────────────────────────────────────────

# Экранирование спецсимволов regex
escape_regex() {
  sed 's/[.[\*^$()+?{|\\]/\\&/g'
}

# CSV в regex с экранированием: "a,b,c" → "(a|b|c)"
csv_to_re() {
  local s="${1:-}" IFS=,
  local out=() token
  for token in $s; do
    token="$(printf '%s' "$token" | escape_regex)"
    out+=("$token")
  done
  printf '(%s)' "$(IFS='|'; echo "${out[*]}")"
}

# ─── Построение regex паттернов ─────────────────────────────────────────────────
CODE_DIRS_RE="$(csv_to_re "$CODE_DIRS")"
CODE_EXTS_RE="$(csv_to_re "$CODE_EXTS")"
DOC_DIRS_RE="$(csv_to_re "$DOC_DIRS")"
DOC_EXTS_RE="$(csv_to_re "$DOC_EXTS")"
DOC_FILES_RE="$(csv_to_re "$DOC_FILES")"
IGNORE_DIRS_RE="$(csv_to_re "$IGNORE_DIRS")"

# Паттерн для документации: папки docs/ ИЛИ файлы *.md ИЛИ корневые файлы
DOCS_RE="^${DOC_DIRS_RE}/|^${DOC_FILES_RE}$|\\.${DOC_EXTS_RE}$"

# Паттерн для кода: папки src/ и т.д. ИЛИ файлы с нужными расширениями
CODE_RE="^${CODE_DIRS_RE}/|\\.${CODE_EXTS_RE}$|(^|/)(Dockerfile|Makefile|docker-compose\\.ya?ml)$"

# Паттерн для игнорирования
IGNORE_RE="^${IGNORE_DIRS_RE}/|\\.ai-docs-system/"

# ─── Получаем изменённые файлы ──────────────────────────────────────────────────
changed_files="$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null)"
[[ -z "$changed_files" ]] && exit 0

# ─── Фильтруем файлы ────────────────────────────────────────────────────────────
changed_docs="$(printf "%s\n" "$changed_files" | grep -E "$DOCS_RE" 2>/dev/null || true)"
changed_code="$(printf "%s\n" "$changed_files" \
  | grep -Ev "$DOCS_RE" \
  | grep -Ev "$IGNORE_RE" \
  | grep -E "$CODE_RE" \
  | head -10 2>/dev/null || true)"

# ─── Показываем напоминание если нужно ──────────────────────────────────────────
if [[ -n "$changed_code" && -z "$changed_docs" ]]; then
  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo "⚠️  Напоминание: изменился код, но документация не обновлена"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""
  echo "Изменённые файлы:"
  echo "$changed_code" | while read -r f; do
    echo "  • $f"
  done
  echo ""
  echo "💡 Рекомендуется обновить документацию:"
  echo "   • Cursor Agent: введите '==' для автообновления"
  echo "   • Или вручную обновите docs/"
  echo ""
  echo "📝 Запись в pending updates для следующего \"==\""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""
fi

# Никогда не блокируем коммит
exit 0
